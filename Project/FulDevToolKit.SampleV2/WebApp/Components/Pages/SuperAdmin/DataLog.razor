@page "/superadmin/datalog"

@inherits LoggedLayout
@layout LoggedLayout

@inject NavigationManager NavigationManager
@inject HttpClient _httpclient
@inject IAppControllerAsync<UserAuthenticated> _appctrl
@inject IAppSettings _settings
@inject IDataCacheProxyManager _cache
@inject ISystemProxyManager _systemservices
@inject IDialogService msgbox
@inject IDialogService timeline


@if (view != null)
{

    <FluentGrid Spacing="3" AdaptiveRendering="true" Style="padding: 4px; ">

        <FluentGridItem lg="10" xs="12">
            <FluentLabel> <h2> @_PageTitle</h2> </FluentLabel>

        </FluentGridItem>

        <FluentGridItem lg="2" xs="12" Style="margin-top: 6px;">

        

        </FluentGridItem>

    </FluentGrid>


    @if (!view.GetTabEditState())
    {
        <FluentGrid Spacing="1" AdaptiveRendering="true" Style="padding: 4px; ">

            <FluentGridItem lg="12" xs="12">

                <FluentAccordion>

                    <FluentAccordionItem Expanded="true" Heading="@view.texts.Get("SearchButtonLabel")">
                        <FluentIcon Value="@(new Icons.Regular.Size24.Search())"
                                    Color="@Color.Accent" Slot="start" />

                            <FluentGrid Spacing="1" AdaptiveRendering="true" Style="padding: 4px; ">

                                 <FluentGridItem lg="6" xs="12">
                                    
                                      @if (view.listTipoOperacao.Count > 0)
                                        {
                                            <FluentSelect TOption="TipoOperacaoValueModel"
                                                  Label=@view.texts.Get("SearchByOperationType-Label")
                                                  Items="@view.listTipoOperacao"
                                                  Id="pOperation"
                                                    Height="250px"
                                                    Width="90%"
                                                    OptionValue="@(p => p.Value)"
                                                    OptionText="@(p => p.Text)"
                                                  @bind-Value="@view.param.pOperation" />                                                                                    
                                        }

                                 </FluentGridItem>
                                 
                                  <FluentGridItem lg="6" xs="12">

                                        @if (view.listTabelas.Count > 0)
                                        {
                                            <FluentSelect TOption="TabelasValueModel"
                                                          Label=@view.texts.Get("SearchByObject-Label")
                                                          Items="@view.listTabelas"
                                                          Id="pTableName"
                                                          Height="250px"
                                                          Width="90%"
                                                          OptionValue="@(p => p.Value)"
                                                          OptionText="@(p => p.Text)"
                                                          @bind-Value="@view.param.pTableName" />
                                      
                                        }
                                </FluentGridItem>

                                <FluentGridItem lg="4" xs="12">

                                <FluentTextField @bind-Value="view.idDataLog" Maxlength="36"
                                                     Label="@view.texts.Get("SearchByRecordID-Label")" style="width:95%">
                                    </FluentTextField>

                                </FluentGridItem>

                                 <FluentGridItem lg="4" xs="12">
                                        
                                        <FluentDatePicker Label="@view.texts.Get("SearchByInicialDate-Label")"
                                                @bind-Value="@view.dataInicio" />
                                         
                                  </FluentGridItem>

                                   <FluentGridItem lg="4" xs="12">

                                             <FluentDatePicker Label="@view.texts.Get("SearchByFinalDate-Label")"
                                                       @bind-Value="@view.dataFim" />                                         
                                    </FluentGridItem>

                                 
   
                                    <FluentGridItem lg="6" xs="12">
                                              <FormActionButton ButtonType=ButtonTypeEnum.SEARCH
                                                  Title="@view.texts.Get("SearchButtonLabel")"
                                                  Visible="true"
                                                  Disabled="!view.Permissions.AllowRead"
                                                  OnAction="OnSearch">
                                              </FormActionButton>

                                    </FluentGridItem>

                             </FluentGrid>

                    </FluentAccordionItem>
                </FluentAccordion>
            </FluentGridItem>


            <FluentGridItem lg="12" xs="12">

                <FluentCard Width="100%" Height="100%" Class="card-layout">

                    <FluentLabel> <h5>@view.texts.Get("SearchResultLabel")</h5> </FluentLabel>

                    <div id="datagrid-container">
                        <FluentDataGrid Items="@view.gridlist"
                                        TGridItem="DataLogResult"
                                        Pagination="@pagination"
                                        RowSize="@rowSize"
                                        ResizableColumns=true                                       
                                        Style="overflow-y:hidden;">

                            <PropertyColumn Property="@(c => c.ID)" Title="ID" Sortable="true" Width="20%" />
                            <PropertyColumn Property="@(c => c.Email)" Title="User" Sortable="true" Width="25%" />
                            <PropertyColumn Property="@(c => c.TableName)" Title="@view.texts.Get("TableName-Label")" Sortable="true" Width="20%" />
                            <PropertyColumn Property="@(c => c.OperationText)" Title="@view.texts.Get("OperationText-Label")" Sortable="true" Width="15%" />
                            <PropertyColumn Property="@(c => c.Date)" Title="@view.texts.Get("Date-Label")" Sortable="true" Width="15%" />
                            
                                <TemplateColumn Title="..." Width="5%">

                                <FluentButton Appearance="Appearance.Lightweight"
                                              IconEnd="@(new Icons.Regular.Size24.DocumentBulletList())"
                                              @onclick="@(() => OnDetClick(context.DataLogID ))">
                                </FluentButton>

                            </TemplateColumn>

                        </FluentDataGrid>
                    </div>

                    <FluentPaginator State="@pagination" />

                </FluentCard>
            </FluentGridItem>

        </FluentGrid>
    }

    @if (view.GetTabEditState())
    {
        <FluentGrid Spacing="3" AdaptiveRendering="true" Style="padding: 4px; ">

            <FluentGridItem lg="1" xs="12" Style="margin-top: 0px;">

                <TaskIconButton OnClick="Back"
                                IconStart="@(new Icons.Regular.Size24.ArrowCircleLeft())">

                </TaskIconButton>

            </FluentGridItem>

            <FluentGridItem lg="9" xs="12">
                <FluentLabel> <h4>@view.ModoLabel</h4> </FluentLabel>

            </FluentGridItem>

        </FluentGrid>

        <FluentCard Width="100%" Height="100%" Class="card-layout">

            <FluentGrid Spacing="3" AdaptiveRendering="true" Style="padding: 4px; ">

                <FluentGridItem lg="12" xs="12" Style="margin-top: 0px;">

                    <FluentLabel Typo="Typography.Header">@view.texts.Get("LogInformation-Label"):</FluentLabel>

                </FluentGridItem>
         
                <FluentGridItem lg="3" xs="12">

                    <FluentTextField Value=@view.result.ID.ToString()  ReadOnly="true"
                                     Label="@view.texts.Get("ID")" style="width:95%">
                    </FluentTextField>

                </FluentGridItem>

                <FluentGridItem lg="3" xs="12">

                    <FluentTextField Value=@view.result.TableName ReadOnly="true"
                                     Label="@view.texts.Get("TableName-Label")" style="width:95%">
                    </FluentTextField>

                </FluentGridItem>

                <FluentGridItem lg="3" xs="12">

                    <FluentTextField Value=@view.result.OperationText ReadOnly="true"
                                     Label="@view.texts.Get("OperationText-Label")" style="width:95%">
                    </FluentTextField>

                </FluentGridItem>

                <FluentGridItem lg="3" xs="12">

                    <FluentTextField Value=@view.result.Date.ToString("yyyy-MM-dd HH:mm") ReadOnly="true"
                                     Label="@view.texts.Get("Date-Label")" style="width:95%">
                    </FluentTextField>

                </FluentGridItem>

                <FluentGridItem lg="6" xs="12">
                    
                        <TaskButton Title="@view.texts.Get("ShowTimeLine-Label")"
                                    ButtonAppearance="Appearance.Accent"
                                    IconEnd="@(new Icons.Regular.Size20.Timeline())"
                                        OnClick="OnGetTimeline">
                        </TaskButton>                    

                </FluentGridItem>

            </FluentGrid>
     
             @if (!view.ShowTimeline)
              {

                  <FluentGrid Spacing="3" AdaptiveRendering="true" Style="padding: 4px; ">

                     <FluentGridItem lg="6" xs="12" Style="margin-top: 5px;">

                        <FluentLabel Alignment="HorizontalAlignment.Center" Style="font-weight:bold"
                            Typo="Typography.Subject">@view.texts.Get("OldVersionData-Label")
                          </FluentLabel>
                      
                     </FluentGridItem>

                    <FluentGridItem lg="6" xs="12" Style="margin-top: 5px;">

                        <FluentLabel Alignment="HorizontalAlignment.Center" Style="font-weight:bold"
                            Typo="Typography.Subject">@view.texts.Get("CurrentVersionData-Label")
                        </FluentLabel>

                    </FluentGridItem>

                   </FluentGrid>

                <FluentGrid Spacing="3" AdaptiveRendering="true" Style="padding: 4px;" >

                    <FluentGridItem lg="6" xs="12" Style="margin-top: 0px;" Class="grid-old-version">

                        @if (view.logold_content != null)
                            {
                                @if (view.logold_content.ToList().Count > 0)
                                {
                                    <div id="datagrid-container">

                                        <FluentDataGrid Items="@view.logold_content"
                                                        TGridItem="DataLogItem"                                                        
                                                        RowSize="@rowSize"
                                                        ResizableColumns=true
                                                        Style="overflow-y:hidden;">

                                            <PropertyColumn Property="@(c => c.ItemName)"  Sortable="true" Title="@view.texts.Get("Field-Label")" Width="50%" />
                                            <PropertyColumn Property="@(c => c.ItemValue)" Title="@view.texts.Get("Value-Label")"  Width="50%" />
                                      
                                        </FluentDataGrid>                                        
                                    </div>
                                                                        
                                }
                                else
                                {
                                    <p> @view.texts.Get("HasNoOldVersion-Label") </p>
                                }
                            }

                     </FluentGridItem>

                     
                     <FluentGridItem lg="6" xs="12" Style="margin-top: 0px;">                                                        

                            @if (view.logcurrent_content != null)
                            {
                            @if (view.logcurrent_content.ToList().Count > 0)
                                {

                                    <div id="datagrid-container">

                                        <FluentDataGrid Items="@view.logcurrent_content"
                                                        TGridItem="DataLogItem"                                                        
                                                        RowSize="@rowSize"
                                                        ResizableColumns=true
                                                        Style="overflow-y:hidden;">

                                        <PropertyColumn Property="@(c => c.ItemName)" Sortable="true" Title="@view.texts.Get("Field-Label")" Width="50%" />
                                            <PropertyColumn Property="@(c => c.ItemValue)" Title="@view.texts.Get("Value-Label")"  Width="50%" />
                                           
                                        </FluentDataGrid>                                          

                                    </div>                                    
                                    
                                }
                                else
                                {
                                        <p> @view.texts.Get("HasNoCurrentVersion-Label")  </p>
                                }
                            }

                     </FluentGridItem>

                 </FluentGrid>
              }                                                                                                    
              else
                {                   
                       <p>
                                
                            @if (view.timeline != null)
                            {
                                @if (view.timeline.Count > 0)
                                {
                                    
                                }
                                else
                                {
                                    <strong> @view.texts.Get("HasNoTimeLine-Label")  </strong>
                                }
                            }                        

                         </p>
                }


        </FluentCard>

    }
   
}
else
{

    <FluentStack Style="margin-bottom: 24px;"
                 VerticalAlignment="VerticalAlignment.Center"
                 HorizontalAlignment="HorizontalAlignment.Center">
        <PageLoading LoadingText="Loading page. Wait..."></PageLoading>

    </FluentStack>

}

<TaskLoading @ref="loading" Content=loadingConfigs></TaskLoading>

@* <DataLogTimeline @ref="modaltimeline"                
                 Content="timelineConfigs"
                 Title="@timelinetitle">
</DataLogTimeline> *@


@code {


    private DataLogViewModel view;

    public TimelineConfigs timelineConfigs = new TimelineConfigs();
    public DataLogTimeline modaltimeline ; 
    

    //


    private string timelinetitle = "";

    protected override Task OnInitializedAsync()
    {
        return base.OnInitializedAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {

        if (firstRender)
        {
            if (await this.InitResources())
            {
                await this.InitCacheAndLocalization();

                this.InitServices();

                view = new DataLogViewModel((_systemservices as SystemProxy),
                   (_cache as DataCacheProxy), user, _httpclient, _settings.ServiceURL, _appctrl.UserInfo.Token);

                view.texts = this.localization;

                view.Permissions
                    = BaseViewModel.SetPermissions(permissions, "SYSDATALOG", false);

                await view.InitializeModels();

                _LoadingData_Text = view.texts.Get("LoadingData");
                _AreaURL = "superadmin";                
                this.SetPageTile(view.texts.Get("DataLog-PageTitle"));
                loadingConfigs= new TaskLoadingConfigs
                    { Title = view.texts.Get("LoadingPage"), 
                        Description = view.texts.Get("DataLogRecord-Label")
                    };

            }

            StateHasChanged();

        }
    }



    public async Task OnSearch()
    {
        await view.Search();

        if (!view.ServiceStatus.Success)
        {
            await msgbox.ShowWarningAsync(view.ServiceStatus.Exceptions.Messages[0].Description,
                view.texts.Get("ErrorOnExecuteSearch"));

        }

    }

    public void OnNew()
    {

        view.InitNew();
        StateHasChanged();
    }

    public async Task OnGet(object id)
    {
        await loading.Begin();

        await view.Get(id);

        await loading.End();

        if (!view.ServiceStatus.Success)
        {
            await msgbox.ShowWarningAsync(view.ServiceStatus.Exceptions.Messages[0].Description,
                view.texts.Get("ErrorOnReturnData"));

        }
        else
        {
            view.InitEdit();

        }

        StateHasChanged();
    }


    public async Task OnSet()
    {

        await view.Set();

        if (!view.ServiceStatus.Success)
        {
            await msgbox.ShowWarningAsync(view.ServiceStatus.Exceptions.Messages[0].Description,
                view.texts.Get("NoticeLabel"));

        }
        else
        {
            await msgbox.ShowSuccessAsync(view.texts.Get("SuccessSaveMessage"),
                view.texts.Get("SuccessLabel"));

            this.Back();

        }


    }

    public async Task OnDetClick(object id)
    {

        await OnGet(id);

    }

    public void Back()
    {
        view.BackToSearch();
        StateHasChanged();

    }

    public void GoHome()
    {
        string url = _appctrl.UserInfo.HomeURL;
        NavigationManager.NavigateTo(url);

    }

    public void BackTimeLine()
    {
        view.ShowTimeline = false;
        StateHasChanged();
    }

    public async Task OnGetTimeline()
    {

        await view.GetTimeline();

        if (!view.ServiceStatus.Success)
        {
            await msgbox.ShowSuccessAsync(view.ServiceStatus.Exceptions.Messages[0].Description,
                  view.texts.Get("ErrorOnReturnData"));                        
        }
        else
        {
            timelinetitle = view.texts.Get("ShowTimeLine-Label") + " - ID: " + view.result.ID;
            //view.ShowTimeline = true;

            timelineConfigs = new TimelineConfigs()
            {                
                TimeLineRecords = view.timeline
            };
            
            DialogParameters tlparams = new ()
            {
                PrimaryActionEnabled = true, 
                PrimaryAction = "Fechar",
                SecondaryAction = "",
                SecondaryActionEnabled = false,
                Title = timelinetitle,
                Width = "700px",
                Modal = false,
                PreventScroll =false
            };

            IDialogReference modal 
                = await timeline.ShowDialogAsync<DataLogTimeline>(timelineConfigs, tlparams);
            DialogResult? result = await modal.Result; 

        }

    }

}
