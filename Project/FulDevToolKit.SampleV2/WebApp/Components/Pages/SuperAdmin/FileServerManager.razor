@page "/superadmin/fileservermanager"

@inherits LoggedLayout
@layout LoggedLayout

@inject NavigationManager NavigationManager
@inject HttpClient _httpclient
@inject IAppControllerAsync<UserAuthenticated> _appctrl
@inject IAppSettings _settings
@inject ISystemProxyManager _systemservices
@inject IFileServerProxyManager _fileservice
@inject IDialogService msgbox
@inject IJSRuntime JSRuntime

@if (view != null)
{

    <FluentGrid Spacing="3" AdaptiveRendering="true" Style="padding: 4px; ">

        <FluentGridItem lg="9" xs="12">
            <FluentLabel> <h2> @_PageTitle</h2> </FluentLabel>

        </FluentGridItem>

        <FluentGridItem lg="3" xs="12" Style="margin-top: 6px;">
                    

        </FluentGridItem>

    </FluentGrid>


    @if (!view.GetTabEditState())
    {
        <FluentGrid Spacing="1" AdaptiveRendering="true" Style="padding: 4px; ">

            <FluentGridItem lg="12" xs="12">

                <FluentAccordion>

                    <FluentAccordionItem Expanded="true" Heading="@view.texts.Get("SearchButtonLabel")">
                        <FluentIcon Value="@(new Icons.Regular.Size24.Search())"
                                    Color="@Color.Accent" Slot="start" />
                        
                            @if (view.dirList != null)
                            {
                                @if (view.dirList.Count > 0)
                                {

                                    <FluentGrid Spacing="3" AdaptiveRendering="true" Style="padding: 4px; ">

                                         <FluentGridItem lg="6" xs="12">
                                                <FluentSelect TOption="DirectoryResult"
                                                              Label=@view.texts.Get("Directory-Label")
                                                              Items="@view.dirList"
                                                              Id="pDirName"
                                                              Height="250px"
                                                              Width="90%"
                                                              OptionValue="@(p => p.Directory)"
                                                              OptionText="@(p => p.Directory)"
                                                              ValueChanged="@OnSelectDirectory" />                                                              
                                       </FluentGridItem>
                                    </FluentGrid>
                                }
                            }
                       
                    </FluentAccordionItem>
                </FluentAccordion>
            </FluentGridItem>


            <FluentGridItem lg="12" xs="12">

                <FluentCard Width="100%" Height="100%" Class="card-layout">

                    <FluentLabel> <h5>@view.texts.Get("SearchResultLabel")</h5> </FluentLabel>

                    <div id="datagrid-container">
                        <FluentDataGrid Items="@view.fileList"
                                        TGridItem="FileListResult"
                                        Pagination="@pagination"
                                        RowSize="@rowSize"
                                        ResizableColumns=true
                                        Style="overflow-y:hidden;">

                            <PropertyColumn Property="@(c => c.Filename)" Title="@view.texts.Get("FileName-Label")" Sortable="true" Width="85%" />                            

                            <TemplateColumn Title="@view.texts.Get("DownloadFile-Label")" Width="15%">

                                <FluentButton Appearance="Appearance.Lightweight"
                                            OnClick="()=>OnDownload(context.Directory,context.Filename)"
                                              IconEnd="@(new Icons.Regular.Size24.ArrowDownload())" >                                              
                                </FluentButton>

                            </TemplateColumn>

                        </FluentDataGrid>
                    </div>

                    <FluentPaginator State="@pagination" />

                </FluentCard>
            </FluentGridItem>

        </FluentGrid>
    }
   

}
else
{

    <FluentStack Style="margin-bottom: 24px;"
                 VerticalAlignment="VerticalAlignment.Center"
                 HorizontalAlignment="HorizontalAlignment.Center">
        <PageLoading LoadingText="Loading page. Wait..."></PageLoading>

    </FluentStack>

}

<TaskLoading @ref="loading" Content=loadingConfigs></TaskLoading>

@code {


    private FileServerViewModel view;

    //

    protected override Task OnInitializedAsync()
    {
        return base.OnInitializedAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {

        if (firstRender)
        {
            if (await this.InitResources())
            {
                await this.InitCacheAndLocalization();

                this.InitServices();

                view = new FileServerViewModel((_fileservice as FileServerProxy),
                    user, _httpclient, _settings.ServiceURL, _appctrl.UserInfo.Token);

                view.texts = this.localization;

                view.Permissions
                    = BaseViewModel.SetPermissions(permissions, "SYSFILESERVER", false);

                await view.InitializeModels();

                _LoadingData_Text = view.texts.Get("LoadingData");
                _AreaURL = "superadmin";
                this.SetPageTile(view.texts.Get("FileServer-PageTitle"));
                loadingConfigs = new TaskLoadingConfigs
                    {
                        Title = view.texts.Get("LoadingPage"),
                    Description = view.texts.Get("FileServer-PageTitle")
                    };                
            }

            StateHasChanged();

        }
    }

    public async Task OnSelectDirectory(string value)
    {
        string defaultitem = view.texts.Get("SelectItem-Description");
        if (defaultitem != value)
        {
            view.param = new FileParam();
            view.param.pDirectory = value; 

            await view.ListFiles(); 
        }

    }

    public async Task OnDownload(string dir, string file)
    {
       
        string url = $"{_settings.ServiceURL}/fileserver/downloadfile?dir={dir}&file={file}";
        await JSRuntime.InvokeVoidAsync("open", url, "_blank");
        
    }

    public void GoHome()
    {
        string url = _appctrl.UserInfo.HomeURL;
        NavigationManager.NavigateTo(url);

    }

    private void OnNew()
    {
        
    }


}