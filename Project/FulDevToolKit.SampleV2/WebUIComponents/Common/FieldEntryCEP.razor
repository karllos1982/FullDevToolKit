@using FullDevToolKit.Helpers;
@inject IDialogService msgbox
@implements IDialogContentComponent<BaseEntryFieldMask>

<FluentTextField Value="@DisplayValue"
                 ReadOnly=true
                 Label="@Label"
                 Style="@Style"
                 @onfocusin="@OpenDialog">
</FluentTextField>

<FluentDialog Hidden="@_hidden" @onkeydown="@KeyDown">
    <FluentDialogHeader ShowDismiss="false">
        <FluentStack VerticalAlignment="VerticalAlignment.Center"
                     HorizontalAlignment="HorizontalAlignment.Center ">

            <FluentLabel Typo="Typography.PaneHeader">
                @Content.Title
            </FluentLabel>

        </FluentStack>
    </FluentDialogHeader>

    <FluentDialogBody>

        <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center"
                     HorizontalAlignment="HorizontalAlignment.Center">
          
            <FluentTextField @ref="fdig1" @bind-Value=dig1 Maxlength="5" @onkeydown="GoToDig2" />
            <span>-</span>
            <FluentTextField @ref="fdig2" @bind-Value=dig2 Maxlength="3" style="width:25%" />

        </FluentStack>


        <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center"
                     HorizontalAlignment="HorizontalAlignment.Center" Style="margin-top:30px">

            <TaskIconButton IconStart="@(new Icons.Regular.Size28.Checkmark())"
                            OnClick="Confirm">
            </TaskIconButton>

            <TaskIconButton IconStart="@(new Icons.Regular.Size28.ArrowExit())"
                            Color="warning" OnClick="CloseDialog">
            </TaskIconButton>

        </FluentStack>


    </FluentDialogBody>

</FluentDialog>


@code {

    private bool _hidden = true;
    private string displayValue = "";
    
    private string dig1 = "";
    private string dig2 = "";
    
    private FluentTextField fdig1;
    private FluentTextField fdig2;

    
    public string? DisplayValue
    {
        get
        {
            string mask = "";

            mask = "#####-###";                                    

            return ToMask(Value, mask);
        }

    }

    [Parameter] public string? Value { get; set; }

    [Parameter] public EventCallback<string?> ValueChanged { get; set; }

    [Parameter] public string? Label { get; set; } = "CEP";

    [Parameter] public string Style { get; set; } = "";    

    public string ToMask(string text, string maskpattern)
    {
        string ret = "";

        int i = 0;
        if (text != null)
        {
            if (text != "")
            {
                ret = string.Concat(maskpattern.Select(c => c == '#' ? text[i++] : c));
            }
        }

        return ret;
    }


    // dialog

    [Parameter]
    public BaseEntryFieldMask Content { get; set; } = new BaseEntryFieldMask();


    [CascadingParameter]
    public FluentDialog Dialog { get; set; } = default!;

    // #####-###
    private void OpenDialog()
    {
        Content.Title = Label;

        string aux = Value.Replace("-", "");
    
        if (aux.Length >= 5)
        {
            dig1 = aux.Substring(0, 5);
        }

        if (aux.Length >= 8)
        {
            dig2 = aux.Substring(5, 3);
        }

        fdig1.FocusAsync();

        _hidden = false;
    }

    private async Task Confirm()
    {
        Validations validation = new Validations();
        string aux = $"{dig1}{dig2}";
        bool isvalid = false;
        
        isvalid = validation.ValidateCEP(aux);
        
        if (isvalid)
        {
            Value = aux;
            await ValueChanged.InvokeAsync(Value);
            _hidden = true;
        }
        else
        {
            await msgbox.ShowWarningAsync("O " + Label + " digitado é inválido.", "Aviso");
        }

    }

    private async Task CloseDialog()
    {
        _hidden = true;
    }


    private async Task GoToDig2(KeyboardEventArgs e)
    {

        if (e.Key == "Enter")
        {
            fdig2.FocusAsync();
        }
    }

    private async Task KeyDown(KeyboardEventArgs e)
    {

        if (e.Key == "Escape")
        {
            await CloseDialog();
        }
    }


}
